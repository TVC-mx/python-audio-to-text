# Procesador de Audio a Texto

Sistema completo en Docker para procesar llamadas de audio desde MySQL y convertirlas a texto usando Whisper.

## ðŸš€ Inicio RÃ¡pido

```bash
# 1. Configurar
cp env.example .env
# Editar .env con tu configuraciÃ³n MySQL

# 2. Construir
docker-compose build

# 3. Probar
./run.sh 2024-01-01 2024-01-31 --dry-run

# 4. Procesar
./run.sh 2024-01-01 2024-01-31
```

## CaracterÃ­sticas

- âœ… ConexiÃ³n a MySQL para obtener llamadas por rango de fechas
- âœ… Descarga automÃ¡tica de audios organizados por carpetas (aÃ±o/mes/dÃ­a)
- âœ… TranscripciÃ³n usando OpenAI Whisper (librerÃ­a gratuita)
- âœ… Procesamiento paralelo para mayor eficiencia
- âœ… Prefijos de user_type en archivos
- âœ… Todo ejecutÃ¡ndose en contenedores Docker
- âœ… Logs detallados y reportes

## Estructura del Proyecto

```
python-audio-to-text/
â”œâ”€â”€ Dockerfile              # Imagen Docker con Python y dependencias
â”œâ”€â”€ docker-compose.yml      # OrquestaciÃ³n de contenedores
â”œâ”€â”€ requirements.txt        # Dependencias de Python
â”œâ”€â”€ config.py              # ConfiguraciÃ³n centralizada
â”œâ”€â”€ database.py            # GestiÃ³n de conexiÃ³n MySQL
â”œâ”€â”€ audio_processor.py     # Procesamiento de audio y transcripciÃ³n
â”œâ”€â”€ main.py               # Script principal
â”œâ”€â”€ env.example           # Ejemplo de variables de entorno
â””â”€â”€ README.md            # Este archivo
```

## Requisitos Previos

- **Docker y Docker Compose** instalados
- **Acceso a MySQL** con las tablas: `calls`, `call_audios`, `branches`, `users`, `persons`
- **URLs de audio accesibles** desde el contenedor Docker
- **4GB de RAM** disponibles para el contenedor (recomendado)

## ðŸ”„ Flujo de Trabajo con Docker

### Paso 1: ConfiguraciÃ³n
```bash
# Clonar/descargar el proyecto
cd python-audio-to-text

# Configurar variables de entorno
cp env.example .env
nano .env  # Editar con tu configuraciÃ³n MySQL
```

### Paso 2: ConstrucciÃ³n
```bash
# Construir la imagen Docker (solo la primera vez o cuando cambies cÃ³digo)
docker-compose build
```

### Paso 3: Prueba
```bash
# Probar conexiÃ³n a MySQL
docker-compose run --rm audio-to-text \
  python -c "from database import DatabaseManager; db = DatabaseManager(); print('ConexiÃ³n:', db.test_connection())"

# Modo dry-run para ver quÃ© se procesarÃ­a
./run.sh 2024-01-01 2024-01-31 --dry-run
```

### Paso 4: Procesamiento
```bash
# Procesar llamadas reales
./run.sh 2024-01-01 2024-01-31

# O con docker-compose directamente
docker-compose run --rm audio-to-text \
  python main.py --start-date 2024-01-01 --end-date 2024-01-31
```

### Paso 5: VerificaciÃ³n
```bash
# Ver archivos generados
ls -la audios/2024/01/15/
ls -la textos/2024/01/15/

# Ver logs
cat logs/processing.log
```

## ConfiguraciÃ³n

### 1. Variables de Entorno

Copia el archivo de ejemplo y configura tus variables:

```bash
cp env.example .env
```

Edita `.env` con tu configuraciÃ³n:

```env
# ConfiguraciÃ³n de MySQL
MYSQL_HOST=tu-servidor-mysql.com
MYSQL_PORT=3306
MYSQL_USER=tu_usuario
MYSQL_PASSWORD=tu_password
MYSQL_DATABASE=llamadas

# URL base para descargar audios (solo si las URLs en la BD no son completas)
AUDIO_BASE_URL=http://tu-servidor.com/audios

# Modelo de Whisper (base recomendado)
WHISPER_MODEL=base
```

### 2. Estructura de Base de Datos

El sistema estÃ¡ configurado para trabajar con tu esquema de base de datos que incluye las siguientes tablas:

```sql
-- Tabla principal de llamadas
calls (
    id, started_at, ended_at, company_id, branch_id, attended_by_employee_id
)

-- Tabla de audios de llamadas
call_audios (
    call_id, user_type, audio_url
)

-- Tabla de sucursales
branches (
    id, name
)

-- Tabla de usuarios
users (
    id, person_id
)

-- Tabla de personas
persons (
    id, full_name
)
```

**Consulta por defecto:**
```sql
SELECT
    c.id AS id,
    c.started_at AS fecha_llamada,
    ca.user_type AS user_type,
    ca.audio_url AS audio_path,
    TIMESTAMPDIFF(SECOND, c.started_at, c.ended_at) AS duracion,
    c.company_id AS telefono_origen,
    c.branch_id AS telefono_destino,
    b.name AS sucursal,
    p.full_name AS atendido_por
FROM calls c
LEFT JOIN branches b ON b.id = c.branch_id
LEFT JOIN users u ON u.id = c.attended_by_employee_id
LEFT JOIN persons p ON p.id = u.person_id
LEFT JOIN call_audios ca ON ca.call_id = c.id
WHERE DATE(c.started_at) BETWEEN %s AND %s
  AND ca.audio_url IS NOT NULL
  AND ca.audio_url != ''
ORDER BY c.started_at ASC;
```

**Nota:** El campo `audio_url` debe contener la URL completa del archivo de audio, como:
```
https://tvc-voximplant.sfo3.digitaloceanspaces.com/2025/06/27/archivo.mp3
```

## ðŸš€ Uso con Docker

### 1. ConfiguraciÃ³n Inicial

```bash
# 1. Configurar variables de entorno
cp env.example .env
# Editar .env con tu configuraciÃ³n MySQL

# 2. Construir la imagen Docker
docker-compose build
```

### 2. EjecuciÃ³n BÃ¡sica

```bash
# Procesar llamadas del 1 al 31 de enero de 2024
docker-compose run --rm audio-to-text \
  python main.py --start-date 2024-01-01 --end-date 2024-01-31
```

### 3. Usando el Script de Ayuda (Recomendado)

```bash
# Hacer ejecutable el script
chmod +x run.sh

# Procesar llamadas
./run.sh 2024-01-01 2024-01-31

# Modo dry-run (solo mostrar quÃ© se procesarÃ­a)
./run.sh 2024-01-01 2024-01-31 --dry-run

# Generar reporte en JSON
./run.sh 2024-01-01 2024-01-31 --json

# Reconstruir imagen y procesar
./run.sh 2024-01-01 2024-01-31 --build
```

### 4. Consultas Personalizadas

```bash
# Solo llamadas de clientes
docker-compose run --rm audio-to-text \
  python main.py \
  --start-date 2024-01-01 \
  --end-date 2024-01-31 \
  --query "SELECT c.id AS id, c.started_at AS fecha_llamada, ca.user_type AS user_type, ca.audio_url AS audio_path FROM calls c LEFT JOIN call_audios ca ON ca.call_id = c.id WHERE DATE(c.started_at) BETWEEN %s AND %s AND ca.user_type = 'cliente' AND ca.audio_url IS NOT NULL"

# Solo llamadas de una sucursal especÃ­fica
docker-compose run --rm audio-to-text \
  python main.py \
  --start-date 2024-01-01 \
  --end-date 2024-01-31 \
  --query "SELECT c.id AS id, c.started_at AS fecha_llamada, ca.user_type AS user_type, ca.audio_url AS audio_path FROM calls c LEFT JOIN call_audios ca ON ca.call_id = c.id WHERE DATE(c.started_at) BETWEEN %s AND %s AND c.branch_id = 123 AND ca.audio_url IS NOT NULL"

# Llamadas con duraciÃ³n mÃ­nima (mÃ¡s de 30 segundos)
docker-compose run --rm audio-to-text \
  python main.py \
  --start-date 2024-01-01 \
  --end-date 2024-01-31 \
  --query "SELECT c.id AS id, c.started_at AS fecha_llamada, ca.user_type AS user_type, ca.audio_url AS audio_path FROM calls c LEFT JOIN call_audios ca ON ca.call_id = c.id WHERE DATE(c.started_at) BETWEEN %s AND %s AND TIMESTAMPDIFF(SECOND, c.started_at, c.ended_at) > 30 AND ca.audio_url IS NOT NULL"
```

### 5. VerificaciÃ³n y Debugging

```bash
# Probar conexiÃ³n a MySQL
docker-compose run --rm audio-to-text \
  python -c "from database import DatabaseManager; db = DatabaseManager(); print('ConexiÃ³n:', db.test_connection())"

# Entrar al contenedor para debugging
docker-compose run --rm audio-to-text bash

# Ver logs en tiempo real
docker-compose logs -f audio-to-text

# Verificar archivos generados
ls -la audios/2024/01/15/
ls -la textos/2024/01/15/
```

### 6. Ejemplos de Uso ComÃºn

```bash
# Procesar llamadas de la Ãºltima semana
./run.sh 2024-01-01 2024-01-07

# Procesar solo llamadas de clientes de un dÃ­a especÃ­fico
docker-compose run --rm audio-to-text \
  python main.py \
  --start-date 2024-01-15 \
  --end-date 2024-01-15 \
  --query "SELECT c.id AS id, c.started_at AS fecha_llamada, ca.user_type AS user_type, ca.audio_url AS audio_path FROM calls c LEFT JOIN call_audios ca ON ca.call_id = c.id WHERE DATE(c.started_at) = '2024-01-15' AND ca.user_type = 'cliente' AND ca.audio_url IS NOT NULL"

# Procesar con reporte detallado
./run.sh 2024-01-01 2024-01-31 --json
```

## Estructura de Archivos Generados

### Audios Descargados
```
audios/
â”œâ”€â”€ 2024/
â”‚   â”œâ”€â”€ 01/
â”‚   â”‚   â”œâ”€â”€ 15/
â”‚   â”‚   â”‚   â”œâ”€â”€ cliente_llamada_001.wav
â”‚   â”‚   â”‚   â””â”€â”€ agente_llamada_002.wav
â”‚   â”‚   â””â”€â”€ 16/
â”‚   â”‚       â””â”€â”€ supervisor_llamada_003.wav
â”‚   â””â”€â”€ 02/
â”‚       â””â”€â”€ 01/
â”‚           â””â”€â”€ cliente_llamada_004.wav
```

### Transcripciones
```
textos/
â”œâ”€â”€ 2024/
â”‚   â”œâ”€â”€ 01/
â”‚   â”‚   â”œâ”€â”€ 15/
â”‚   â”‚   â”‚   â”œâ”€â”€ cliente_llamada_001.txt
â”‚   â”‚   â”‚   â””â”€â”€ agente_llamada_002.txt
â”‚   â”‚   â””â”€â”€ 16/
â”‚   â”‚       â””â”€â”€ supervisor_llamada_003.txt
â”‚   â””â”€â”€ 02/
â”‚       â””â”€â”€ 01/
â”‚           â””â”€â”€ cliente_llamada_004.txt
```

### Logs
```
logs/
â”œâ”€â”€ processing.log                    # Log general
â”œâ”€â”€ procesamiento_2024-01-01_2024-01-31.log  # Log de resultados
â””â”€â”€ reporte_2024-01-01_2024-01-31.json       # Reporte JSON (opcional)
```

## Modelos de Whisper Disponibles

| Modelo  | TamaÃ±o | Velocidad | PrecisiÃ³n | Uso Recomendado |
|---------|--------|-----------|-----------|-----------------|
| tiny    | 39 MB  | Muy rÃ¡pido| Baja      | Pruebas rÃ¡pidas |
| base    | 74 MB  | RÃ¡pido    | Buena     | **Recomendado** |
| small   | 244 MB | Medio     | Muy buena | ProducciÃ³n      |
| medium  | 769 MB | Lento     | Excelente | Alta calidad    |
| large   | 1550 MB| Muy lento | MÃ¡xima    | MÃ¡xima calidad  |

## ðŸ”§ SoluciÃ³n de Problemas

### Error de ConexiÃ³n MySQL
```bash
# Verificar conectividad desde el contenedor
docker-compose run --rm audio-to-text \
  python -c "from database import DatabaseManager; db = DatabaseManager(); print('ConexiÃ³n:', db.test_connection())"

# Verificar configuraciÃ³n
docker-compose run --rm audio-to-text \
  python -c "from config import Config; c = Config(); print(f'Host: {c.MYSQL_HOST}, DB: {c.MYSQL_DATABASE}')"
```

### Error de Descarga de Audio
```bash
# Verificar acceso a URLs desde el contenedor
docker-compose run --rm audio-to-text \
  python -c "import requests; print('Test URL:', requests.get('https://tvc-voximplant.sfo3.digitaloceanspaces.com/2025/06/27/test.mp3', timeout=5).status_code)"

# Verificar configuraciÃ³n de red
docker-compose run --rm audio-to-text ping google.com
```

### Error de NumPy/Whisper
```bash
# Si ves error "Numpy is not available" o conflictos de NumPy 2.x
# Reconstruir la imagen con versiones compatibles
docker-compose down
docker-compose build --no-cache

# Verificar que NumPy se instalÃ³ correctamente
docker-compose run --rm audio-to-text \
  python -c "import numpy; print('NumPy version:', numpy.__version__)"
```

### Error de Memoria
```bash
# Reducir concurrencia en .env
echo "MAX_CONCURRENT_TRANSCRIPTIONS=1" >> .env
echo "WHISPER_MODEL=tiny" >> .env

# Verificar uso de memoria
docker stats audio-to-text-processor
```

### Error de Permisos
```bash
# Verificar permisos de directorios
ls -la audios/ textos/ logs/

# Corregir permisos si es necesario
chmod -R 755 audios/ textos/ logs/
```

### Verificar Procesamiento
```bash
# Ver logs en tiempo real
docker-compose logs -f audio-to-text

# Ver logs especÃ­ficos
tail -f logs/processing.log

# Verificar archivos generados
find audios/ -name "*.mp3" | head -5
find textos/ -name "*.txt" | head -5

# Verificar tamaÃ±o de archivos
du -sh audios/ textos/
```

### Reconstruir Todo
```bash
# Limpiar contenedores e imÃ¡genes
docker-compose down
docker system prune -f

# Reconstruir desde cero
docker-compose build --no-cache
```

### Debugging Avanzado
```bash
# Entrar al contenedor para debugging
docker-compose run --rm audio-to-text bash

# Dentro del contenedor:
python -c "import whisper; print('Whisper disponible')"
python -c "import mysql.connector; print('MySQL connector disponible')"
python main.py --start-date 2024-01-01 --end-date 2024-01-31 --dry-run
```

## PersonalizaciÃ³n

### Consulta SQL Personalizada

Puedes usar tu propia consulta SQL pasÃ¡ndola como parÃ¡metro:

```bash
docker-compose run --rm audio-to-text \
  python main.py \
  --start-date 2024-01-01 \
  --end-date 2024-01-31 \
  --query "SELECT id, fecha_llamada, user_type, audio_path FROM llamadas WHERE user_type IN ('cliente', 'agente') AND DATE(fecha_llamada) BETWEEN %s AND %s ORDER BY fecha_llamada"
```

### Modificar ConfiguraciÃ³n

Edita `config.py` para ajustar:
- Formatos de archivo
- Estructura de carpetas
- ConfiguraciÃ³n de Whisper
- LÃ­mites de procesamiento

## Rendimiento

- **Procesamiento paralelo**: Descarga y transcripciÃ³n simultÃ¡neas
- **ReutilizaciÃ³n**: No reprocesa archivos ya transcritos
- **Memoria optimizada**: ConfiguraciÃ³n de recursos en docker-compose
- **Logs detallados**: Seguimiento completo del proceso

## Soporte

Para problemas o mejoras, revisa los logs en `./logs/` y ajusta la configuraciÃ³n segÃºn tus necesidades.
